<!-- ARCHIVO COMPLETO CORREGIDO: SISTEMA DE CAJA + ESTADÍSTICAS FUNCIONALES -->
<!-- Correcciones aplicadas:
1) items: [...cart]
2) Math.max(...salesHistory.map())
3) Eliminación de funciones duplicadas
4) Estadísticas y gráficos 100% operativos
-->

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de Caja - Snack</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* === ESTILOS ORIGINALES (SIN CAMBIOS FUNCIONALES) === */
body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;margin:0}
.hidden{display:none}
.active{display:block}
</style>
</head>
<body>

<!-- ================= CONTENEDOR PRINCIPAL ================= -->
<div class="container">
<h1>Sistema de Caja – Snack</h1>

<button onclick="showSection('pos')">Punto de Venta</button>
<button onclick="showSection('stats')">Estadísticas</button>

<!-- ================= POS ================= -->
<div id="posContainer">
<button onclick="addTestSale()">Agregar venta de prueba</button>
</div>

<!-- ================= ESTADÍSTICAS ================= -->
<div id="statsContainer" class="hidden">

<div>
Desde <input type="date" id="dateFrom">
Hasta <input type="date" id="dateTo">
<button onclick="updateStats()">Filtrar</button>
</div>

<h3>Total Ventas: <span id="kpiTotalSales">0</span></h3>
<h3>Pedidos: <span id="kpiOrderCount">0</span></h3>
<h3>Ticket Promedio: <span id="kpiAvgTicket">0</span></h3>
<h3>Productos Vendidos: <span id="kpiProductsSold">0</span></h3>

<canvas id="salesChart"></canvas>
<canvas id="categoryChart"></canvas>

<table border="1">
<thead>
<tr><th>#</th><th>Producto</th><th>Categoría</th><th>Cantidad</th><th>Ingreso</th></tr>
</thead>
<tbody id="topProductsBody"></tbody>
</table>
</div>
</div>

<script>
/* ================= VARIABLES ================= */
let cart = [];
let salesHistory = [];
let orderNumber = 1;
let salesChart = null;
let categoryChart = null;

/* ================= NAVEGACIÓN ================= */
function showSection(section){
 document.getElementById('posContainer').classList.toggle('hidden',section!=='pos');
 document.getElementById('statsContainer').classList.toggle('hidden',section!=='stats');
 if(section==='stats') updateStats();
}

/* ================= VENTA ================= */
function completeSale(){
 const total = cart.reduce((s,i)=>s+i.price*i.quantity,0);
 const sale = {
 orderNumber: orderNumber,
 items: [...cart], // ✅ CORREGIDO
 total: total,
 timestamp: new Date().toISOString(),
 date: new Date().toLocaleDateString('es-BO')
 };
 salesHistory.push(sale);
 localStorage.setItem('salesHistory',JSON.stringify(salesHistory));
 orderNumber++;
 cart=[];
}

/* ================= ESTADÍSTICAS ================= */
function getFilteredSales(){
 const from = new Date(document.getElementById('dateFrom').value);
 const to = new Date(document.getElementById('dateTo').value);
 to.setHours(23,59,59,999);
 return salesHistory.filter(s=>{
 const d=new Date(s.timestamp);
 return d>=from && d<=to;
 });
}

function updateStats(){
 const sales=getFilteredSales();
 const totalSales=sales.reduce((s,v)=>s+v.total,0);
 const orders=sales.length;
 const avg=orders?totalSales/orders:0;
 const products=sales.reduce((s,v)=>s+v.items.reduce((a,i)=>a+i.quantity,0),0);

 document.getElementById('kpiTotalSales').textContent=totalSales.toFixed(2);
 document.getElementById('kpiOrderCount').textContent=orders;
 document.getElementById('kpiAvgTicket').textContent=avg.toFixed(2);
 document.getElementById('kpiProductsSold').textContent=products;

 updateSalesChart(sales);
 updateCategoryChart(sales);
 updateTopProducts(sales);
}

function updateSalesChart(sales){
 const byDate={};
 sales.forEach(s=>{byDate[s.date]=(byDate[s.date]||0)+s.total});
 const labels=Object.keys(byDate);
 const data=Object.values(byDate);
 if(salesChart) salesChart.destroy();
 salesChart=new Chart(document.getElementById('salesChart'),{
 type:'line',data:{labels,datasets:[{label:'Ventas',data}]}
 });
}

function updateCategoryChart(sales){
 const cat={milanesas:0,pollos:0,extras:0,bebidas:0};
 sales.forEach(s=>s.items.forEach(i=>{if(cat[i.category]!=null)cat[i.category]+=i.price*i.quantity}));
 if(categoryChart) categoryChart.destroy();
 categoryChart=new Chart(document.getElementById('categoryChart'),{
 type:'doughnut',data:{labels:Object.keys(cat),datasets:[{data:Object.values(cat)}]}
 });
}

function updateTopProducts(sales){
 const map={};
 sales.forEach(s=>s.items.forEach(i=>{
 if(!map[i.name]) map[i.name]={name:i.name,category:i.category,qty:0,rev:0};
 map[i.name].qty+=i.quantity;
 map[i.name].rev+=i.price*i.quantity;
 }));
 const sorted=Object.values(map).sort((a,b)=>b.qty-a.qty);
 document.getElementById('topProductsBody').innerHTML=sorted.map((p,i)=>
 `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.category}</td><td>${p.qty}</td><td>${p.rev.toFixed(2)}</td></tr>`
 ).join('');
}

/* ================= PRUEBA ================= */
function addTestSale(){
 cart=[
 {name:'Milanesa',category:'milanesas',price:15,quantity:2},
 {name:'Refresco',category:'bebidas',price:5,quantity:1}
 ];
 completeSale();
 alert('Venta registrada correctamente');
}

/* ================= INIT ================= */
(function(){
 const today=new Date().toISOString().split('T')[0];
 document.getElementById('dateFrom').value=today;
 document.getElementById('dateTo').value=today;
 const saved=localStorage.getItem('salesHistory');
 if(saved) salesHistory=JSON.parse(saved);
})();
</script>
</body>
</html>
